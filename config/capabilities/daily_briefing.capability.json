{
  "id": "daily_briefing",
  "version": "1.0.0",
  "description": "Assemble un briefing quotidien multi-sources (emails Gmail, événements Google Calendar, tâches Monday) et le formate avec des liens d'actions tout en gérant les cas où certaines données manquent.",
  "inputs": [
    "input.time_window.start",
    "input.time_window.end",
    "input.email_limit",
    "input.task_limit",
    "context.gmail.recipient",
    "context.gmail.query",
    "context.calendar.timezone",
    "context.monday.board_id"
  ],
  "outputs": [
    "memory.state.briefing.summary",
    "memory.state.briefing.sent_message"
  ],
  "steps": [
    {
      "id": "fetch_emails",
      "type": "tool",
      "ref": "gmail",
      "when": "input.time_window.start != null && input.time_window.end != null",
      "params": {
        "action": "message.getMany",
        "query": "{{context.gmail.query}} after:{{input.time_window.start}} before:{{input.time_window.end}}",
        "limit": "{{input.email_limit}}"
      },
      "save": {
        "to": {
          "memory.state.gmail.messages": "$.data.messages"
        }
      }
    },
    {
      "id": "fetch_events",
      "type": "tool",
      "ref": "google-calendar",
      "when": "input.time_window.start != null && input.time_window.end != null",
      "params": {
        "action": "event.getAll",
        "timeMin": "{{input.time_window.start}}",
        "timeMax": "{{input.time_window.end}}",
        "timeZone": "{{context.calendar.timezone}}"
      },
      "save": {
        "to": {
          "memory.state.calendar.events": "$.data.events"
        }
      }
    },
    {
      "id": "fetch_tasks",
      "type": "tool",
      "ref": "monday",
      "when": "context.monday.board_id != null",
      "params": {
        "action": "boardItem.getMany",
        "boardId": "{{context.monday.board_id}}",
        "limit": "{{input.task_limit}}"
      },
      "save": {
        "to": {
          "memory.state.monday.items": "$.data.items"
        }
      }
    },
    {
      "id": "format_briefing",
      "type": "tool",
      "ref": "openai",
      "params": {
        "action": "summarize",
        "text": "Rédige un briefing quotidien clair et concis pour la période {{input.time_window.start}} -> {{input.time_window.end}}.\n- Emails Gmail (peut être vide): {{memory.state.gmail.messages}}\n- Evénements Calendar (peut être vide): {{memory.state.calendar.events}}\n- Tâches Monday (peut être vide): {{memory.state.monday.items}}\nFormate en markdown avec des puces. Pour chaque source, saute les sections sans données, affiche les intitulés lisibles et propose des liens cliquables quand un champ de lien ou d'identifiant est fourni (ex: htmlLink, webViewLink, permalink, id). Termine par des appels à l'action explicites (répondre à un mail, ouvrir une tâche, rejoindre un événement)."
      },
      "save": {
        "to": {
          "memory.state.briefing.summary": "$.data.summary"
        }
      }
    },
    {
      "id": "send_briefing",
      "type": "tool",
      "ref": "gmail",
      "when": "context.gmail.recipient != null && memory.state.briefing.summary != null",
      "params": {
        "action": "message.send",
        "to": "{{context.gmail.recipient}}",
        "subject": "Briefing quotidien",
        "text": "{{memory.state.briefing.summary}}"
      },
      "save": {
        "to": {
          "memory.state.briefing.sent_message": "$.data.message"
        }
      }
    }
  ]
}
