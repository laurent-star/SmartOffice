{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "contracts/envelope.schema.json",
  "title": "Envelope",
  "description": "Message container used between trigger/agent/executor. Strictly one of: legacy OR execution.",
  "oneOf": [
    {
      "title": "Legacy envelope (context/input/output/error)",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "context": {
          "type": "object",
          "description": "Contexte d'exécution, inclut la mémoire d'agent.",
          "additionalProperties": true,
          "properties": {
            "memory": {
              "$ref": "https://smart-office.local/schemas/memory.schema.json",
              "description": "Mémoire persistante de la session."
            }
          },
          "required": ["memory"]
        },
        "input": {
          "type": "object",
          "description": "Entrée de l'enveloppe, généralement la liste des steps à exécuter.",
          "additionalProperties": true,
          "properties": {
            "steps": {
              "type": "array",
              "minItems": 1,
              "description": "Liste ordonnée des steps à exécuter.",
              "items": {
                "$ref": "https://smart-office.local/schemas/step.schema.json"
              }
            }
          }
        },
        "output": {
          "type": "object",
          "description": "Sortie produite par l'exécution (résultat business ou technique)."
        },
        "error": {
          "type": ["object", "null"],
          "description": "Erreur éventuelle rencontrée lors de l'exécution."
        }
      },
      "required": ["context"]
    },
    {
      "title": "Execution envelope (header/payload)",
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "header": {
          "type": "object",
          "description": "Métadonnées d'exécution (identifiant, version, source, etc.)",
          "additionalProperties": false,
          "properties": {
            "id": {
              "type": "string",
              "minLength": 1,
              "description": "Identifiant unique de l'enveloppe."
            },
            "version": {
              "type": "string",
              "minLength": 1,
              "description": "Version du protocole ou du langage utilisé."
            },
            "trace_id": {
              "type": "string",
              "description": "Identifiant de traçabilité pour le suivi des appels."
            },
            "timestamp": {
              "anyOf": [
                { "type": "string", "format": "date" },
                { "type": "string", "format": "date-time" }
              ],
              "description": "Horodatage de l'émission de l'enveloppe."
            },
            "source": {
              "type": "string",
              "minLength": 1,
              "description": "Origine de l'enveloppe (ex: trigger, agent, etc.)."
            },
            "destination": {
              "type": "string",
              "minLength": 1,
              "description": "Destinataire prévu de l'enveloppe."
            },
            "type": {
              "type": "string",
              "minLength": 1,
              "description": "Type d'enveloppe ou d'action attendue."
            }
          },
          "required": [
            "id",
            "version",
            "timestamp",
            "source",
            "destination",
            "type"
          ]
        },
        "payload": {
          "type": "object",
          "description": "Contenu métier à exécuter (steps, mémoire, résultat).",
          "additionalProperties": false,
          "properties": {
            "steps": {
              "type": "array",
              "minItems": 1,
              "description": "Liste ordonnée des steps à exécuter.",
              "items": {
                "$ref": "https://smart-office.local/schemas/step.schema.json"
              }
            },
            "registryFiles": {
              "type": "array",
              "description": "Fichiers de registry injectés par les triggers (tools, capabilities, usecases).",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                  "category": {
                    "enum": ["tools", "capabilities", "usecases"],
                    "description": "Catégorie de registry transportée."
                  },
                  "ref": {
                    "type": "string",
                    "minLength": 1,
                    "description": "Référence du fragment de registry (souvent identique à la catégorie)."
                  },
                  "content": {
                    "type": "object",
                    "description": "Contenu JSON brut de la registry pour la catégorie donnée.",
                    "additionalProperties": true
                  }
                },
                "required": ["category", "ref", "content"]
              }
            },
            "memory": {
              "$ref": "https://smart-office.local/schemas/memory.schema.json",
              "description": "Mémoire persistante de la session."
            },
            "result": {
              "$ref": "https://smart-office.local/schemas/result.schema.json",
              "description": "Résultat de l'exécution (succès ou erreur)."
            },
            "options": {
              "type": "object",
              "description": "Options d'exécution, notamment la registry de secours.",
              "additionalProperties": true,
              "properties": {
                "fallbackRegistry": {
                  "type": "object",
                  "description": "Registry locale de secours lorsque les fichiers Drive sont absents.",
                  "additionalProperties": true,
                  "properties": {
                    "tools": { "type": "object" },
                    "capabilities": { "type": "object" },
                    "usecases": { "type": "object" }
                  }
                }
              }
            },
            "fallbackRegistry": {
              "type": "object",
              "description": "Alias direct pour la registry de secours (compatibilité).",
              "additionalProperties": true
            }
          },
          "anyOf": [
            { "required": ["steps"] },
            { "required": ["registryFiles"] }
          ]
        }
      },
      "required": ["header", "payload"]
    }
  ]
}
