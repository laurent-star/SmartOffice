{
  "name": "so.trigger.registry-loader",
  "nodes": [
    {
      "id": "node-trigger",
      "name": "Trigger Event",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        200,
        300
      ]
    },
    {
      "id": "download-tools",
      "name": "Download Tools Registry",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 1,
      "continueOnFail": true,
      "position": [
        420,
        300
      ],
      "parameters": {
        "resource": "file",
        "operation": "download",
        "fileId": "={{$env.REGISTRY_TOOLS_FILE_ID}}",
        "binaryPropertyName": "data"
      }
    },
    {
      "id": "parse-tools",
      "name": "Parse Tools Registry",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        640,
        300
      ],
      "parameters": {
        "language": "javascript",
        "jsCode": "const binary = items[0].binary?.data;\nif (!binary || !binary.data) {\n  return [{ json: { toolsRegistry: null } }];\n}\nconst content = Buffer.from(binary.data, 'base64').toString('utf8');\nconst toolsRegistry = JSON.parse(content);\nreturn [{ json: { toolsRegistry } }];"
      }
    },
    {
      "id": "download-capabilities",
      "name": "Download Capabilities Registry",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 1,
      "continueOnFail": true,
      "position": [
        420,
        520
      ],
      "parameters": {
        "resource": "file",
        "operation": "download",
        "fileId": "={{$env.REGISTRY_CAPABILITIES_FILE_ID}}",
        "binaryPropertyName": "data"
      }
    },
    {
      "id": "parse-capabilities",
      "name": "Parse Capabilities Registry",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        640,
        520
      ],
      "parameters": {
        "language": "javascript",
        "jsCode": "const binary = items[0].binary?.data;\nif (!binary || !binary.data) {\n  return [{ json: { capabilitiesRegistry: null } }];\n}\nconst content = Buffer.from(binary.data, 'base64').toString('utf8');\nconst capabilitiesRegistry = JSON.parse(content);\nreturn [{ json: { capabilitiesRegistry } }];"
      }
    },
    {
      "id": "merge-registries-a",
      "name": "Merge Registries A",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 1,
      "position": [
        860,
        420
      ],
      "parameters": {
        "mode": "mergeByIndex"
      }
    },
    {
      "id": "download-usecases",
      "name": "Download Usecases Registry",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 1,
      "continueOnFail": true,
      "position": [
        420,
        740
      ],
      "parameters": {
        "resource": "file",
        "operation": "download",
        "fileId": "={{$env.REGISTRY_USECASES_FILE_ID}}",
        "binaryPropertyName": "data"
      }
    },
    {
      "id": "parse-usecases",
      "name": "Parse Usecases Registry",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        640,
        740
      ],
      "parameters": {
        "language": "javascript",
        "jsCode": "const binary = items[0].binary?.data;\nif (!binary || !binary.data) {\n  return [{ json: { usecasesRegistry: null } }];\n}\nconst content = Buffer.from(binary.data, 'base64').toString('utf8');\nconst usecasesRegistry = JSON.parse(content);\nreturn [{ json: { usecasesRegistry } }];"
      }
    },
    {
      "id": "merge-registries-b",
      "name": "Merge Registries B",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 1,
      "position": [
        1080,
        520
      ],
      "parameters": {
        "mode": "mergeByIndex"
      }
    },
    {
      "id": "build-envelope",
      "name": "Build Execution Envelope",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        1300,
        520
      ],
      "parameters": {
        "language": "javascript",
        "jsCode": "const fs = require('fs');\nconst path = require('path');\n\nconst input = items[0].json || {};\nconst now = new Date().toISOString();\n\nconst registryFileNames = {\n  tools: 'tools.json',\n  capabilities: 'capabilities.json',\n  usecases: 'usecases.json',\n};\n\nconst readLocalRegistry = (fileName) => {\n  const candidates = [\n    path.join(process.cwd(), 'registries', fileName),\n    path.join(process.cwd(), '..', 'registries', fileName),\n    path.join('/workspace/SmartOffice/registries', fileName),\n  ];\n\n  for (const candidate of candidates) {\n    if (fs.existsSync(candidate)) {\n      const content = fs.readFileSync(candidate, 'utf8');\n      return JSON.parse(content);\n    }\n  }\n\n  return null;\n};\n\nconst buildRegistryEntry = (category, content) => ({ category, ref: category, content });\n\nconst registryFiles = [];\nconst fallbackRegistry = {};\n\nconst resolvedTools = input.toolsRegistry || readLocalRegistry(registryFileNames.tools);\nif (resolvedTools) {\n  registryFiles.push(buildRegistryEntry('tools', resolvedTools));\n  fallbackRegistry.tools = { tools: resolvedTools };\n}\n\nconst resolvedCapabilities = input.capabilitiesRegistry || readLocalRegistry(registryFileNames.capabilities);\nif (resolvedCapabilities) {\n  registryFiles.push(buildRegistryEntry('capabilities', resolvedCapabilities));\n  fallbackRegistry.capabilities = { capabilities: resolvedCapabilities };\n}\n\nconst resolvedUsecases = input.usecasesRegistry || readLocalRegistry(registryFileNames.usecases);\nif (resolvedUsecases) {\n  registryFiles.push(buildRegistryEntry('usecases', resolvedUsecases));\n  fallbackRegistry.usecases = { usecases: resolvedUsecases };\n}\n\nconst payload = {\n  registryFiles,\n  memory: { session_id: null, state: {}, stack: [] },\n};\n\nif (Object.keys(fallbackRegistry).length > 0) {\n  payload.options = { fallbackRegistry };\n}\n\nconst envelope = {\n  header: {\n    id: `env-${Date.now()}`,\n    version: '1.0',\n    timestamp: now,\n    source: 'so.trigger.registry-loader',\n    destination: 'executor',\n    type: 'execution'\n  },\n  payload,\n};\n\nreturn [{ json: envelope }];"
      }
    }
  ],
  "connections": {
    "Trigger Event": {
      "main": [
        [
          {
            "node": "Download Tools Registry",
            "type": "main",
            "index": 0
          },
          {
            "node": "Download Capabilities Registry",
            "type": "main",
            "index": 0
          },
          {
            "node": "Download Usecases Registry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Tools Registry": {
      "main": [
        [
          {
            "node": "Parse Tools Registry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Tools Registry": {
      "main": [
        [
          {
            "node": "Merge Registries A",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Capabilities Registry": {
      "main": [
        [
          {
            "node": "Parse Capabilities Registry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Capabilities Registry": {
      "main": [
        [
          {
            "node": "Merge Registries A",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Registries A": {
      "main": [
        [
          {
            "node": "Merge Registries B",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Usecases Registry": {
      "main": [
        [
          {
            "node": "Parse Usecases Registry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Usecases Registry": {
      "main": [
        [
          {
            "node": "Merge Registries B",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Registries B": {
      "main": [
        [
          {
            "node": "Build Execution Envelope",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  }
}
